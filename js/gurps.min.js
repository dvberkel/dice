/*! dice - v0.0.3 - 2013-07-13
* Copyright (c) 2013 ; Licensed  */
GURPS={version:""},function(a,b,c,d){var e=c.Model.extend({defaults:{sides:6,random:Math.random},sides:function(){return this.get("sides")},cast:function(){var a=Math.floor(this.get("random")()*this.sides()+1);return this.trigger("cast",a),a}}),f=c.Collection.extend({model:e,cast:function(){var a=0;return this.each(function(b){a+=b.cast()}),a}}),g=function(){var a=1,b=6;this.amount=function(b){return a=b,this},this.sides=function(a){return b=a,this},this.build=function(){for(var c=new f,d=0;a>d;d++)c.add(new e({sides:b}));return c}},h=c.Model.extend({defaults:{multiplier:1,basis:0},initialize:function(){if(!this.has("dice")){var a=(new g).amount(1).sides(6).build();this.set("dice",a)}},multiply:function(a){return this.set("multiplier",a),this},basis:function(a){return this.set("basis",a),this},cast:function(){var a=this.get("dice").cast(),b=this.get("multiplier")*a+this.get("basis");return this.trigger("cast",b),b}});d.Die=e,d.Dice=f,d.DiceBuilder=g,d.DiceValue=h}(jQuery,_,Backbone,GURPS),GURPS.Parser=function(){function a(a){return'"'+a.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\x08/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/[\x00-\x07\x0B\x0E-\x1F\x80-\uFFFF]/g,escape)+'"'}var b={parse:function(b,c){function d(a){s>q||(q>s&&(s=q,t=[]),t.push(a))}function e(){var a,b,c,d,e;return d=q,e=q,a=f(),null!==a?(b=i(),null!==b?(c=k(),null!==c?a=[a,b,c]:(a=null,q=e)):(a=null,q=e)):(a=null,q=e),null!==a&&(a=function(a,b,c,d){return c.multiply(b).basis(d)}(d,a[0],a[1],a[2])),null===a&&(q=d),a}function f(){var a,c,e,f;return e=q,f=q,a=h(),null!==a?(42===b.charCodeAt(q)?(c="*",q++):(c=null,0===r&&d('"*"')),null!==c?a=[a,c]:(a=null,q=f)):(a=null,q=f),null!==a&&(a=function(a,b){return b}(e,a[0])),null===a&&(q=e),null===a&&(a=g()),a}function g(){var a,b;return b=q,a="",null!==a&&(a=function(){return 1}(b)),null===a&&(q=b),a}function h(){var a,c,e;if(e=q,/^[0-9]/.test(b.charAt(q))?(c=b.charAt(q),q++):(c=null,0===r&&d("[0-9]")),null!==c)for(a=[];null!==c;)a.push(c),/^[0-9]/.test(b.charAt(q))?(c=b.charAt(q),q++):(c=null,0===r&&d("[0-9]"));else a=null;return null!==a&&(a=function(a,b){return parseInt(b.join(""),10)}(e,a)),null===a&&(q=e),a}function i(){var a,c,e,f,g;return f=q,g=q,a=h(),null!==a?(100===b.charCodeAt(q)?(c="d",q++):(c=null,0===r&&d('"d"')),null!==c?(e=j(),null!==e?a=[a,c,e]:(a=null,q=g)):(a=null,q=g)):(a=null,q=g),null!==a&&(a=function(a,b,c){var d=(new GURPS.DiceBuilder).amount(b).sides(c).build();return new GURPS.DiceValue({dice:d})}(f,a[0],a[2])),null===a&&(q=f),a}function j(){var a,c,e,f,g;if(f=q,g=q,/^[1-9]/.test(b.charAt(q))?(a=b.charAt(q),q++):(a=null,0===r&&d("[1-9]")),null!==a){for(c=[],/^[0-9]/.test(b.charAt(q))?(e=b.charAt(q),q++):(e=null,0===r&&d("[0-9]"));null!==e;)c.push(e),/^[0-9]/.test(b.charAt(q))?(e=b.charAt(q),q++):(e=null,0===r&&d("[0-9]"));null!==c?a=[a,c]:(a=null,q=g)}else a=null,q=g;return null!==a&&(a=function(a,b,c){return parseInt(b+c.join(""),10)}(f,a[0],a[1])),null===a&&(q=f),a}function k(){var a,b,c,d;return c=q,d=q,a=m(),null!==a?(b=h(),null!==b?a=[a,b]:(a=null,q=d)):(a=null,q=d),null!==a&&(a=function(a,b,a){return b*a}(c,a[0],a[1])),null===a&&(q=c),null===a&&(a=l()),a}function l(){var a,b;return b=q,a="",null!==a&&(a=function(){return 0}(b)),null===a&&(q=b),a}function m(){var a,c;return c=q,43===b.charCodeAt(q)?(a="+",q++):(a=null,0===r&&d('"+"')),null!==a&&(a=function(){return 1}(c)),null===a&&(q=c),null===a&&(c=q,45===b.charCodeAt(q)?(a="-",q++):(a=null,0===r&&d('"-"')),null!==a&&(a=function(){return-1}(c)),null===a&&(q=c)),a}function n(a){a.sort();for(var b=null,c=[],d=0;d<a.length;d++)a[d]!==b&&(c.push(a[d]),b=a[d]);return c}function o(){for(var a=1,c=1,d=!1,e=0;e<Math.max(q,s);e++){var f=b.charAt(e);"\n"===f?(d||a++,c=1,d=!1):"\r"===f||"\u2028"===f||"\u2029"===f?(a++,c=1,d=!0):(c++,d=!1)}return{line:a,column:c}}var p={expression:e,factor:f,empty_factor:g,number:h,dice:i,positive_number:j,offset:k,empty_offset:l,delta:m};if(void 0!==c){if(void 0===p[c])throw new Error("Invalid rule name: "+a(c)+".")}else c="expression";var q=0,r=0,s=0,t=[],u=p[c]();if(null===u||q!==b.length){var v=Math.max(q,s),w=v<b.length?b.charAt(v):null,x=o();throw new this.SyntaxError(n(t),w,v,x.line,x.column)}return u},toSource:function(){return this._source}};return b.SyntaxError=function(b,c,d,e,f){function g(b,c){var d,e;switch(b.length){case 0:d="end of input";break;case 1:d=b[0];break;default:d=b.slice(0,b.length-1).join(", ")+" or "+b[b.length-1]}return e=c?a(c):"end of input","Expected "+d+" but "+e+" found."}this.name="SyntaxError",this.expected=b,this.found=c,this.message=g(b,c),this.offset=d,this.line=e,this.column=f},b.SyntaxError.prototype=Error.prototype,b}(),function(a,b,c){var d=b.Model.extend({defaults:{description:"3d6"},initialize:function(){this.on("change:description",this.process,this),this.process()},process:function(){try{var a=c.Parser.parse(this.get("description"));this.monitor(a)}catch(b){this.unset("dice")}},monitor:function(a){if(this.has("reporter")){var b=this.get("reporter");a.get("dice").each(function(a){b.monitor(a)})}this.set("dice",a)},isValid:function(){return this.has("dice")},cast:function(){this.has("dice")&&this.trigger("cast",this.get("dice").cast())}});c.Description=d}(_,Backbone,GURPS),function(a){var b=openDatabase("gurps_dice","1.0","results of dice throws",5242880);b.transaction(function(a){a.executeSql("create table if not exists versions (timestamp, version)"),a.executeSql("create table if not exists results (timestamp, sides, value)")}),b.transaction(function(a){a.executeSql("select version from versions order by version desc",[],function(b,c){var d=c.rows.length;0===d&&a.executeSql("insert into versions (timestamp, version) values (?, ?)",[(new Date).getTime(),"1.0"])})}),a.database={connection:function(){return b}}}(GURPS),function(a,b,c,d){var e=c.View.extend({initialize:function(){this.render()},render:function(){var b=a("body");new f({model:this.model,el:b}),new g({model:this.model,el:b}),new h({el:b})}}),f=c.View.extend({options:{offset:1},initialize:function(){this.model.on("change:description",this.render,this),this.render()},render:function(){var a=this.input(),b=this.model.get("description");a.attr("value",b),a.attr("size",b.length+this.options.offset),a.removeClass(),a.addClass(this.model.isValid()?"valid":"invalid")},input:function(){var b=this;if(!b._input){var c=a("<input id='description' type='text'/>");c.keyup(function(){b.model.set("description",c.val())}),c.keypress(function(a){13===a.which&&b.model.cast()}),c.appendTo(b.$el),b._input=c}return b._input}}),g=c.View.extend({options:{last:"_"},initialize:function(){this.model.on("change:description",this.clear,this),this.model.on("change:description",this.render,this),this.model.on("cast",this.cast,this),this.render()},clear:function(){this.options.last="_"},render:function(){var a=this.span();this.model.isValid()?(a.show(),a.text(this.options.last)):a.hide()},span:function(){if(!this._span){var b=a("<span class='result'>_</span>");b.click(function(){console.log("clicked")}),b.appendTo(this.$el),this._span=b}return this._span},cast:function(a){this.options.last=a,this.render()}}),h=c.View.extend({template:b.template("<option value='<%= sides %>'><%= sides %></option>"),initialize:function(){this.render()},render:function(){var a=this.selection();a.val("6")},selection:function(){if(!this._selection){var b=a("<select class='sides'></selection");b.appendTo(this.$el),this._selection=b}return this.populate(this._selection),this._selection},populate:function(a){var b=this.template;a.empty();var c=d.database.connection();c.transaction(function(c){c.executeSql("select distinct(sides) from results",[],function(c,d){for(var e=d.rows,f=0;f<e.length;f++){var g=e.item(f);a.append(b(g))}})})}});d.MainView=e}(jQuery,_,Backbone,GURPS),function(a,b){var c=function(b){var c=b.stores||[];this.report=function(b,d){a.each(c,function(a){a.store(b,d)})},this.monitor=function(a){var b=this;a.on("cast",function(a){b.report(this.sides(),a)},a)}},d=function(){var a=b.database.connection();this.store=function(b,c){a.transaction(function(a){a.executeSql("insert into results (timestamp, sides, value) values (?, ?, ?)",[(new Date).getTime(),b,c])})}};b.Reporter=c,b.WebSqlStore=d}(_,GURPS);