GURPS={version:"0.0.3"},function(e,t,n,r){var i=n.Model.extend({defaults:{sides:6,random:Math.random},sides:function(){return this.get("sides")},cast:function(){var e=Math.floor(this.get("random")()*this.sides()+1);return this.trigger("cast",e),e}}),s=n.Collection.extend({model:i,cast:function(){var e=0;return this.each(function(t){e+=t.cast()}),e}}),o=function(){var e=1,t=6;this.amount=function(t){return e=t,this},this.sides=function(e){return t=e,this},this.build=function(){var n=new s;for(var r=0;r<e;r++)n.add(new i({sides:t}));return n}},u=n.Model.extend({defaults:{multiplier:1,basis:0},initialize:function(){if(!this.has("dice")){var e=(new o).amount(1).sides(6).build();this.set("dice",e)}},multiply:function(e){return this.set("multiplier",e),this},basis:function(e){return this.set("basis",e),this},cast:function(){var e=this.get("dice").cast(),t=this.get("multiplier")*e+this.get("basis");return this.trigger("cast",t),t}});r.Die=i,r.Dice=s,r.DiceBuilder=o,r.DiceValue=u}(jQuery,_,Backbone,GURPS),GURPS.Parser=function(){function e(e){return'"'+e.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\x08/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/[\x00-\x07\x0B\x0E-\x1F\x80-\uFFFF]/g,escape)+'"'}var t={parse:function(t,n){function a(e,t,n){var r=e,i=n-e.length;for(var s=0;s<i;s++)r=t+r;return r}function f(e){var t=e.charCodeAt(0),n,r;return t<=255?(n="x",r=2):(n="u",r=4),"\\"+n+a(t.toString(16).toUpperCase(),"0",r)}function l(e){if(i<o)return;i>o&&(o=i,u=[]),u.push(e)}function c(){var e,t,n,r,s;return r=i,s=i,e=h(),e!==null?(t=v(),t!==null?(n=g(),n!==null?e=[e,t,n]:(e=null,i=s)):(e=null,i=s)):(e=null,i=s),e!==null&&(e=function(e,t,n,r){return n.multiply(t).basis(r)}(r,e[0],e[1],e[2])),e===null&&(i=r),e}function h(){var e,n,r,o;return r=i,o=i,e=d(),e!==null?(t.charCodeAt(i)===42?(n="*",i++):(n=null,s===0&&l('"*"')),n!==null?e=[e,n]:(e=null,i=o)):(e=null,i=o),e!==null&&(e=function(e,t){return t}(r,e[0])),e===null&&(i=r),e===null&&(e=p()),e}function p(){var e,t;return t=i,e="",e!==null&&(e=function(e){return 1}(t)),e===null&&(i=t),e}function d(){var e,n,r;r=i,/^[0-9]/.test(t.charAt(i))?(n=t.charAt(i),i++):(n=null,s===0&&l("[0-9]"));if(n!==null){e=[];while(n!==null)e.push(n),/^[0-9]/.test(t.charAt(i))?(n=t.charAt(i),i++):(n=null,s===0&&l("[0-9]"))}else e=null;return e!==null&&(e=function(e,t){return parseInt(t.join(""),10)}(r,e)),e===null&&(i=r),e}function v(){var e,n,r,o,u;return o=i,u=i,e=d(),e!==null?(t.charCodeAt(i)===100?(n="d",i++):(n=null,s===0&&l('"d"')),n!==null?(r=m(),r!==null?e=[e,n,r]:(e=null,i=u)):(e=null,i=u)):(e=null,i=u),e!==null&&(e=function(e,t,n){var r=(new GURPS.DiceBuilder).amount(t).sides(n).build();return new GURPS.DiceValue({dice:r})}(o,e[0],e[2])),e===null&&(i=o),e}function m(){var e,n,r,o,u;o=i,u=i,/^[1-9]/.test(t.charAt(i))?(e=t.charAt(i),i++):(e=null,s===0&&l("[1-9]"));if(e!==null){n=[],/^[0-9]/.test(t.charAt(i))?(r=t.charAt(i),i++):(r=null,s===0&&l("[0-9]"));while(r!==null)n.push(r),/^[0-9]/.test(t.charAt(i))?(r=t.charAt(i),i++):(r=null,s===0&&l("[0-9]"));n!==null?e=[e,n]:(e=null,i=u)}else e=null,i=u;return e!==null&&(e=function(e,t,n){return parseInt(t+n.join(""),10)}(o,e[0],e[1])),e===null&&(i=o),e}function g(){var e,t,n,r;return n=i,r=i,e=b(),e!==null?(t=d(),t!==null?e=[e,t]:(e=null,i=r)):(e=null,i=r),e!==null&&(e=function(e,t,e){return t*e}(n,e[0],e[1])),e===null&&(i=n),e===null&&(e=y()),e}function y(){var e,t;return t=i,e="",e!==null&&(e=function(e){return 0}(t)),e===null&&(i=t),e}function b(){var e,n;return n=i,t.charCodeAt(i)===43?(e="+",i++):(e=null,s===0&&l('"+"')),e!==null&&(e=function(e){return 1}(n)),e===null&&(i=n),e===null&&(n=i,t.charCodeAt(i)===45?(e="-",i++):(e=null,s===0&&l('"-"')),e!==null&&(e=function(e){return-1}(n)),e===null&&(i=n)),e}function w(e){e.sort();var t=null,n=[];for(var r=0;r<e.length;r++)e[r]!==t&&(n.push(e[r]),t=e[r]);return n}function E(){var e=1,n=1,r=!1;for(var s=0;s<Math.max(i,o);s++){var u=t.charAt(s);u==="\n"?(r||e++,n=1,r=!1):u==="\r"||u==="\u2028"||u==="\u2029"?(e++,n=1,r=!0):(n++,r=!1)}return{line:e,column:n}}var r={expression:c,factor:h,empty_factor:p,number:d,dice:v,positive_number:m,offset:g,empty_offset:y,delta:b};if(n!==undefined){if(r[n]===undefined)throw new Error("Invalid rule name: "+e(n)+".")}else n="expression";var i=0,s=0,o=0,u=[],S=r[n]();if(S===null||i!==t.length){var x=Math.max(i,o),T=x<t.length?t.charAt(x):null,N=E();throw new this.SyntaxError(w(u),T,x,N.line,N.column)}return S},toSource:function(){return this._source}};return t.SyntaxError=function(t,n,r,i,s){function o(t,n){var r,i;switch(t.length){case 0:r="end of input";break;case 1:r=t[0];break;default:r=t.slice(0,t.length-1).join(", ")+" or "+t[t.length-1]}return i=n?e(n):"end of input","Expected "+r+" but "+i+" found."}this.name="SyntaxError",this.expected=t,this.found=n,this.message=o(t,n),this.offset=r,this.line=i,this.column=s},t.SyntaxError.prototype=Error.prototype,t}(),function(e,t,n){var r=t.Model.extend({defaults:{description:"3d6"},initialize:function(){this.on("change:description",this.process,this),this.process()},process:function(){try{var e=n.Parser.parse(this.get("description"));this.monitor(e)}catch(t){this.unset("dice")}},monitor:function(e){if(this.has("reporter")){var t=this.get("reporter");e.get("dice").each(function(e){t.monitor(e)})}this.set("dice",e)},isValid:function(){return this.has("dice")},cast:function(){this.has("dice")&&this.trigger("cast",this.get("dice").cast())}});n.Description=r}(_,Backbone,GURPS),function(e){var t=openDatabase("gurps_dice","1.0","results of dice throws",5242880);t.transaction(function(e){e.executeSql("create table if not exists versions (timestamp, version)"),e.executeSql("create table if not exists results (timestamp, sides, value)")}),t.transaction(function(e){e.executeSql("select version from versions order by version desc",[],function(t,n){var r=n.rows.length;r===0&&e.executeSql("insert into versions (timestamp, version) values (?, ?)",[(new Date).getTime(),"1.0"])})}),e.database={connection:function(){return t}}}(GURPS),function(e,t,n,r){var i=n.View.extend({initialize:function(){this.render()},render:function(){var t=e("body");new s({model:this.model,el:t}),new o({model:this.model,el:t}),new u({el:t})}}),s=n.View.extend({options:{offset:1},initialize:function(){this.model.on("change:description",this.render,this),this.render()},render:function(){var e=this.input(),t=this.model.get("description");e.attr("value",t),e.attr("size",t.length+this.options.offset),e.removeClass(),e.addClass(this.model.isValid()?"valid":"invalid")},input:function(){var t=this;if(!t._input){var n=e("<input id='description' type='text'/>");n.keyup(function(){t.model.set("description",n.val())}),n.keypress(function(e){e.which===13&&t.model.cast()}),n.appendTo(t.$el),t._input=n}return t._input}}),o=n.View.extend({options:{last:"_"},initialize:function(){this.model.on("change:description",this.clear,this),this.model.on("change:description",this.render,this),this.model.on("cast",this.cast,this),this.render()},clear:function(){this.options.last="_"},render:function(){var e=this.span();this.model.isValid()?(e.show(),e.text(this.options.last)):e.hide()},span:function(){if(!this._span){var t=e("<span class='result'>_</span>");t.click(function(){console.log("clicked")}),t.appendTo(this.$el),this._span=t}return this._span},cast:function(e){this.options.last=e,this.render()}}),u=n.View.extend({template:t.template("<option value='<%= sides %>'><%= sides %></option>"),initialize:function(){this.render()},render:function(){var e=this.selection();e.val("6")},selection:function(){if(!this._selection){var t=e("<select class='sides'></selection");t.appendTo(this.$el),this._selection=t}return this.populate(this._selection),this._selection},populate:function(e){var t=this.template;e.empty();var n=r.database.connection();n.transaction(function(n){n.executeSql("select distinct(sides) from results",[],function(n,r){var i=r.rows;for(var s=0;s<i.length;s++){var o=i.item(s);e.append(t(o))}})})}});r.MainView=i}($,_,Backbone,GURPS),function(e,t){var n=function(t){var n=t.stores||[];this.report=function(t,r){e.each(n,function(e){e.store(t,r)})},this.monitor=function(e){var t=this;e.on("cast",function(e){t.report(this.sides(),e)},e)}},r=function(){var e=t.database.connection();this.store=function(t,n){e.transaction(function(e){e.executeSql("insert into results (timestamp, sides, value) values (?, ?, ?)",[(new Date).getTime(),t,n])})}};t.Reporter=n,t.WebSqlStore=r}(_,GURPS);